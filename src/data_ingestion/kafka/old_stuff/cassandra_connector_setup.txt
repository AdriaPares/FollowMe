# We ditch the Python API for the native one

# Set up Cassandra Connector

# Following this in part for now: https://www.confluent.io/blog/kafka-connect-cassandra-sink-the-perfect-match/
# which is outdated (datamountaineer merged with landoop). This is a supprot source:
# https://medium.com/walmartlabs/getting-started-with-the-kafka-connect-cassandra-source-e6e06ec72e97
# https://docs.lenses.io/connectors/source/cassandra.html

# Install the connector. Do this on all Kafka nodes

wget https://github.com/Landoop/stream-reactor/releases/download/1.2.1/kafka-connect-cassandra-1.2.1-2.1.0-all.tar.gz
sudo tar zxvf kafka-connect-cassandra-1.2.1-2.1.0-all.tar.gz

# Make directory

sudo mkdir -p /opt/stream-reactor
sudo tar xzvf kafka-connect-cassandra-1.2.1-2.1.0-all.tar.gz -C /opt/stream-reactor

## WARNING IF YOU STOP HERE, YOUR KAFKA DIES. FOLLOW THROUGH

# Add plugin.path to connect-standalone.properties and if connect-distributed.properties is required)

plugin.path=/opt/stream-reactor

# Delete jar files from home (if we moved it it's no longer there...)

rm ~/kafka-connect-cassandra-1.2.1-2.1.0-all.jar

## AFTER THIS, START YOUR ZOOKEEPER AND KAFKA TO SEE IF IT IS WORKING

# Create topics for connector (check topics first, usually it auto creates them)
bin/kafka-topics.sh — create — zookeeper localhost:2181 — topic connect-configs — replication-factor 2 — partitions 1 — config cleanup.policy=compact
bin/kafka-topics.sh — create — zookeeper localhost:2181 — topic connect-offsets — replication-factor 2 — partitions 50 — config cleanup.policy=compact
bin/kafka-topics.sh — create — zookeeper localhost:2181 — topic connect-status — replication-factor 2 — partitions 10 — config cleanup.policy=compact

# Configure Connector

sudo vi connect-cassandra-source.json

# Write (change platform accordingly)
{
    "name": "twitch",
    "config": {
        "tasks.max": "1",
        "connector.class": "com.datamountaineer.streamreactor.connect.cassandra.source.CassandraSourceConnector",

        "connect.cassandra.contact.points": "localhost",
        "connect.cassandra.port": 9042,
        "connect.cassandra.username": "cassandra",
        "connect.cassandra.password": "cassandra",
        "connect.cassandra.consistency.level": "LOCAL_ONE",
        "connect.cassandra.key.space": "blog",
        "connect.cassandra.import.mode": "incremental",
        "connect.cassandra.kcql": "INSERT INTO test_topic SELECT event_data, event_ts FROM pack_events IGNORE event_ts PK event_ts WITHUNWRAP INCREMENTALMODE=TIMESTAMP",
        ...
    }
}

## At this point I've realised that this is to use Cassandra as a Source, we turno to the mountaineer article here...

# Edit the schema enabling in connect-distributed.properties and the cluster

ec2-35-175-19-186.compute-1.amazonaws.com:9092, ec2-3-213-145-221.compute-1.amazonaws.com:9092, ec2-3-219-251-176.compute-1.amazonaws.com:9092

# Create cassandra-sink-distributed-orders.properties

sudo vi cassandra-sink-distributed-orders.properties



# Add:
{
    "name": "twitch",
    "config": {
        "tasks.max": "1",
        "connector.class": "com.datamountaineer.streamreactor.connect.cassandra.source.CassandraSourceConnector",

        "connect.cassandra.contact.points": "10.0.0.5,10.0.0.7,10.0.0.12,10.0.0.19",
        "connect.cassandra.port": 9042,
        "connect.cassandra.username": "cassandra",
        "connect.cassandra.password": "cassandra",
        "connect.cassandra.consistency.level": "LOCAL_ONE",
        "connect.cassandra.key.space": "insight",
        "connect.cassandra.import.mode": "incremental",
        "connect.cassandra.kcql": "INSERT INTO twitch_live SELECT * FROM twitch-topic"
    }
}

#name=cassandra-sink-twitch
#connector.class=com.datamountaineer.streamreactor.connect.cassandra.sink.CassandraSinkConnector
#tasks.max=1
#topics=twitch-topic
#connect.cassandra.export.route.query=INSERT INTO twitch_live SELECT * FROM twitch-topic
#connect.cassandra.contact.points=10.0.0.5,10.0.0.7,10.0.0.12,10.0.0.19
#connect.cassandra.port=9042
#connect.cassandra.key.space=insight
#connect.cassandra.username=cassandra
#connect.cassandra.password=cassandra

# I don't know if we need username or password? maybe take them out if something goes wrong? for now we leave it...

# Open port 8083 sec group


name=cassandra-sink-twitch
connector.class=com.datamountaineer.streamreactor.connect.cassandra.sink.CassandraSinkConnector
tasks.max=1
topics=twitch-topic
connect.cassandra.kcql=INSERT INTO twitch_live SELECT * FROM twitch-topic
connect.cassandra.contact.points=10.0.0.5,10.0.0.7,10.0.0.12,10.0.0.19
connect.cassandra.port=9042
connect.cassandra.key.space=insight








# Initiate connector

bin/connect-distributed.sh config/connect-distributed.properties